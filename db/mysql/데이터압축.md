# 데이터 압축

데이터가 커지면 정말 단순히 "행(row)이 많아진다"는 문제만 생길까요?
실제로 운영 환경에서 먼저 체감되는 문제는 성능보다도 디스크 사용량입니다.
InnoDB는 데이터를 16KB 고정 크기의 페이지 단위로 저장하는데,
이 구조에서는 실제 데이터가 몇 KB에 불과하더라도 페이지 하나가 항상 16KB를 차지합니다.
데이터와 인덱스가 늘어날수록 이러한 페이지가 계속 쌓이고,
그 결과 디스크 사용량은 데이터 크기보다 훨씬 빠른 속도로 증가합니다.
이 문제는 단순한 저장 공간 낭비를 넘어, 스토리지 증설 비용 증가와 백업·복구 시간 증가로 이어지며 운영 부담을 키웁니다.

이를 해결하기 위해 DBMS에서는 `압축` 기능을 제공합니다.


## 페이지 압축
페이지 압축은 디스크에 저장하는 시점에 데이터 페이지가 압축되어 저장되고 디스크에서 페이지를 읽어올 때 압축이 해제됩니다.
그래서 MySQL 서버의 내부 코드에서는 압축 여부와 관계없이 투명(Transparent)하게 동작합니다.

MySQL은 페이지 단위(16KB)로 동작하는데 데이터 페이지를 압축한 결과가 용량이 얼마나 될지 예측이 불가능하다는 문제가 있습니다.
그래서 페이지 압축 기능은 운영체제별로 특정 버전의 파일 시스템에서만 지원되는 `펀치 홀` 이라는 기능을 사용합니다.
운영체제의 블록 사이즈가 512바이트인 경우, 페이지 압축은 다음과 같이 동작합니다.
1. 데이터 페이지의 압축된 페이지가 7KB라면 나머지 9KB의 펀치 홀을 생성합니다.
2. 파일 시스템은 7KB만 남기고 나머지 디스크의 9KB 공간은 운영체제로 반납합니다.

그런데 이 펀치 홀 기능은 운영체제뿐만 아니라 하드웨어 자체에서도 해당 기능을 지원해야 사용 가능합니다.
또 다른 문제는 파일 시스템 관련 명령어가 펀치 홀을 지원하지 못한다는 것입니다.
예를 들어 cp와 같은 일반적인 파일 복사 명령어는 파일을 연속된 바이트 스트림으로 읽어 다시 기록하는 방식으로 동작하기 때문에,
펀치 홀 구간을 0으로 읽은 뒤 이를 실제 데이터로 기록해 버립니다.
그 결과 펀치 홀은 유지되지 않고, 데이터 파일의 실제 디스크 사용량은 다시 원래의 16KB 페이지 단위 크기로 커질 수 있습니다.

이런 이유로 `페이지 압축`은 많이 사용되지 않습니다.

## 테이블 압축
InnoDB는 페이지 단위(16kb)로 동작합니다. 그래서 레코드 하나하나 말고 페이지 전체를 통째로 압축하는데요 문제는 압축 크기를 예측할 수 없다는 것입니다.

그래서 `KEY_BLOCK_SIZE`를 정하고 그 크기에 맞춰 페이지를 스플릿하는 방식으로 동작합니다. 예를 들어 `KEY_BLOCK_SIZE`가 8KB라고 가정해보겠습니다.
```
1. 16kb의 데이터 페이지를 압축
   1.1 압축된 결과가 8KB이하면 그대로 디스크에 저장
   1.2. 압축된 결과가 8KB이상이면 원본 페이지를 스플릿해서 2개의 페이지에 8KB씩 저장 
2. 나뉜 페이지에 대해 1번을 반복
```
다음과 같이 동작하기 때문에 목표 크기(KEY_BLOCK_SIZE)가 잘못 설정되면 MySQL의 성능을 급격히 떨어질 수 있습니다.

그런데 압축된 페이지를 그대로 메모리에 올려서 쿼리를 처리할 수 있을까요? InnoDB는 압축된 상태의 페이지로는 레코드를 읽거나 수정할 수 없습니다. 따라서 쿼리를 실행하려면 반드시 압축을 해제한 페이지가 필요합니다.

InnoDB는 이를 효율적으로 관리하기 위해 두 가지 버전의 페이지를 관리합니다.
1. LRU리스트:
    1. 디스크에서 읽은 압축된 상태 그대로의 페이지
    2. 압축 테이블 + 비압축 테이블의 페이지가 모두 섞여 있음
2. Unzip_LRU 리스트:
    1. 압축을 해제한 페이지
    2. 압축 테이블의 페이지만 존재
    3. 실제 쿼리 실행에 사용됨

이 구조는 디스크 공간 문제는 해결했지만, 메모리와 CPU 측면에서 새로운 비용을 만들어냅니다.
1. 버퍼 풀 공간 이중 사용: 압축 테이블의 페이지는 LRU에 한 번, Unzip_LRU에 한 번 결과적으로 버퍼 풀을 2배로 사용합니다.
2. CPU 비용 증가:
    1. 페이지를 읽을 때 압축 해제 필요
    2. 페이지를 변경할 때 압축 해제 -> 수정 -> 재압축

그래서 InnoDB는 이 문제를 해결하기 위해 상황에 따라 다르게 행동하는 전략(Adaptive)을 선택합니다.
1. 버퍼 풀이 부족한 경우:
    1. LRU 리스트에는 압축된 페이지만 유지
    2. Unzip_LRU 리스트에서 압축 해제된 페이지 제거
    3. 필요하면 다시 압축 해제
2. 압축된 페이지가 자주 사용되는 경우:
    1. Unzip_LRU에 압축 해제된 페이지를 계속 유지
    2. 압축/해제 반복 최소화 






